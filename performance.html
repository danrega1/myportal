<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Reviews | Leadership Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="shared.js"></script>
  <style>
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    
    const Icon = ({ name, className = "w-5 h-5" }) => {
      const ref = React.useRef(null);
      useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('class', className);
          ref.current.appendChild(icon);
        }
      }, [name, className]);
      return <span ref={ref} className="inline-flex items-center justify-center" />;
    };

    function PerformancePortal() {
      const [isLoading, setIsLoading] = useState(true);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [syncStatus, setSyncStatus] = useState('idle');
      const [syncMessage, setSyncMessage] = useState('');
      const [lastSynced, setLastSynced] = useState(null);
      const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
      const [allData, setAllData] = useState(null);
      const [performanceData, setPerformanceData] = useState(null);
      const [selectedMember, setSelectedMember] = useState(null);

      // Check URL params for direct member link
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const member = params.get('member');
        if (member) {
          setSelectedMember(member);
          setActiveTab('member');
        }
      }, []);

      useEffect(() => {
        const init = async () => {
          if (!getToken()) {
            window.location.href = 'index.html';
            return;
          }
          await loadData();
          setIsLoading(false);
        };
        init();
      }, []);

      const [initialLoadDone, setInitialLoadDone] = useState(false);
      useEffect(() => {
        if (initialLoadDone) setHasUnsavedChanges(true);
      }, [performanceData]);

      const loadData = async () => {
        setSyncStatus('loading');
        try {
          let data = await loadFromCloud();
          if (!data) data = getDefaultData();
          setAllData(data);
          setPerformanceData(data.performanceReview || getDefaultPerformanceData());
          setLastSynced(new Date());
          setSyncStatus('idle');
          setInitialLoadDone(true);
        } catch (error) {
          console.error('Load error:', error);
          setSyncStatus('error');
          setSyncMessage('Failed to load data');
        }
      };

      const saveData = async () => {
        setSyncStatus('saving');
        setSyncMessage('Saving...');
        try {
          const newData = {
            ...allData,
            performanceReview: performanceData,
            lastUpdated: new Date().toISOString()
          };
          await saveToCloud(newData);
          setAllData(newData);
          setSyncStatus('success');
          setSyncMessage('Saved!');
          setLastSynced(new Date());
          setHasUnsavedChanges(false);
          setTimeout(() => setSyncStatus('idle'), 2000);
        } catch (error) {
          setSyncStatus('error');
          setSyncMessage('Save failed');
          setTimeout(() => setSyncStatus('idle'), 3000);
        }
      };

      if (isLoading || !performanceData) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <Icon name="Loader" className="w-12 h-12 text-indigo-600 animate-spin" />
          </div>
        );
      }

      const renderSyncBar = () => (
        <div className="bg-white border-b px-4 py-2 flex flex-wrap items-center justify-between gap-2">
          <div className="flex items-center gap-4">
            <a href="index.html" className="flex items-center gap-2 text-gray-600 hover:text-gray-800">
              <Icon name="ChevronLeft" className="w-4 h-4" /> Home
            </a>
            <div className="flex items-center gap-2">
              {hasUnsavedChanges ? <Icon name="CloudOff" className="w-4 h-4 text-amber-500" /> : <Icon name="Cloud" className="w-4 h-4 text-green-500" />}
              <span className="text-sm text-gray-600">
                {hasUnsavedChanges ? 'Unsaved changes' : lastSynced ? `Synced: ${lastSynced.toLocaleTimeString()}` : ''}
              </span>
            </div>
            {syncStatus !== 'idle' && (
              <span className={`text-sm flex items-center gap-1 ${syncStatus === 'error' ? 'text-red-600' : syncStatus === 'success' ? 'text-green-600' : 'text-indigo-600'}`}>
                {(syncStatus === 'saving' || syncStatus === 'loading') && <Icon name="Loader" className="w-3 h-3 animate-spin" />}
                {syncMessage}
              </span>
            )}
          </div>
          <div className="flex items-center gap-2">
            <button onClick={loadData} disabled={syncStatus === 'loading' || syncStatus === 'saving'}
              className="flex items-center gap-1 px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50">
              <Icon name="Download" className="w-4 h-4" /> Load
            </button>
            <button onClick={saveData} disabled={syncStatus === 'loading' || syncStatus === 'saving'}
              className={`flex items-center gap-1 px-3 py-1.5 text-sm rounded-lg disabled:opacity-50 ${hasUnsavedChanges ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <Icon name="Upload" className="w-4 h-4" /> Save
            </button>
          </div>
        </div>
      );

      const renderDashboard = () => {
        const allMembers = Object.keys(performanceData.teamMembers);
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {['NCS', 'CSTIMS'].map(team => (
                <div key={team} className="bg-white rounded-xl shadow-sm border p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Icon name="Users" className="w-5 h-5 text-indigo-500" />{team} Team
                  </h3>
                  <div className="space-y-3">
                    {performanceData.teams[team].map(member => {
                      const overall = calculateOverallScore(member, performanceData);
                      const prev = performanceData.teamMembers[member]?.scores2024?.overall || 0;
                      const diff = (overall - prev).toFixed(2);
                      return (
                        <div key={member} onClick={() => { setSelectedMember(member); setActiveTab('member'); }}
                          className="flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-semibold text-indigo-600">{member.charAt(0)}</div>
                            <span className="font-medium">{member}</span>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${getRatingColor(overall)}`}>{overall}</span>
                            <span className={`text-sm ${parseFloat(diff) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {parseFloat(diff) >= 0 ? '↑' : '↓'} {Math.abs(diff)}
                            </span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  <div className="mt-4 pt-4 border-t">
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-500">Team Average:</span>
                      <span className="font-semibold">
                        {(performanceData.teams[team].reduce((sum, m) => sum + parseFloat(calculateOverallScore(m, performanceData)), 0) / performanceData.teams[team].length).toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4">Rating Distribution</h3>
              <div className="grid grid-cols-5 gap-4">
                {[5, 4, 3, 2, 1].map(rating => {
                  const count = allMembers.filter(m => Math.round(calculateOverallScore(m, performanceData)) === rating).length;
                  return (
                    <div key={rating} className="text-center">
                      <div className={`h-24 rounded-lg flex items-end justify-center ${getRatingColor(rating)}`}>
                        <div className="w-full bg-current opacity-30 rounded-lg" style={{ height: `${(count / allMembers.length) * 100}%`, minHeight: count > 0 ? '20%' : '0' }}></div>
                      </div>
                      <p className="mt-2 font-medium">{rating}</p>
                      <p className="text-sm text-gray-500">{count} people</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      const renderMember = () => {
        if (!selectedMember) return <div className="text-center py-12 text-gray-500">Select a team member from the dashboard</div>;
        const member = performanceData.teamMembers[selectedMember];
        if (!member) return null;
        
        const caresAvg = calculateCategoryAvg(selectedMember, 'aamvaCares', performanceData);
        const compAvg = calculateCategoryAvg(selectedMember, 'competencies', performanceData);
        const goalsAvg = calculateGoalsAvg(selectedMember, performanceData);
        const overall = calculateOverallScore(selectedMember, performanceData);

        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <button onClick={() => setActiveTab('dashboard')} className="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                <Icon name="ChevronLeft" className="w-5 h-5" /> Back to Dashboard
              </button>
            </div>
            
            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-2xl font-bold text-indigo-600">{member.name.charAt(0)}</div>
                  <div>
                    <h2 className="text-2xl font-bold">{member.name}</h2>
                    <p className="text-gray-500">{member.team} Team</p>
                  </div>
                </div>
                <div className="text-right">
                  <div className={`text-4xl font-bold ${getRatingColor(overall).split(' ')[0]}`}>{overall}</div>
                  <div className={`text-sm px-3 py-1 rounded-full inline-block mt-1 ${getRatingColor(overall)}`}>{getRatingLabel(overall)}</div>
                </div>
              </div>
              <div className="grid grid-cols-3 gap-4">
                <div className="p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-600 mb-1">AAMVA CARES (25%)</p>
                  <p className="text-2xl font-bold text-blue-700">{caresAvg.manager}</p>
                  <p className="text-xs text-blue-500">Self: {caresAvg.self}</p>
                </div>
                <div className="p-4 bg-purple-50 rounded-lg">
                  <p className="text-sm text-purple-600 mb-1">Competencies (25%)</p>
                  <p className="text-2xl font-bold text-purple-700">{compAvg.manager}</p>
                  <p className="text-xs text-purple-500">Self: {compAvg.self}</p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg">
                  <p className="text-sm text-green-600 mb-1">Goals (50%)</p>
                  <p className="text-2xl font-bold text-green-700">{goalsAvg.manager}</p>
                  <p className="text-xs text-green-500">Self: {goalsAvg.self}</p>
                </div>
              </div>
            </div>

            {/* AAMVA CARES */}
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="Heart" className="w-5 h-5 text-red-500" />AAMVA CARES</h3>
              <div className="space-y-4">
                {performanceData.criteria.aamvaCares.map(criterion => {
                  const data = member.aamvaCares[criterion.id];
                  if (!data) return null;
                  return (
                    <div key={criterion.id} className="p-4 bg-gray-50 rounded-lg">
                      <div className="flex justify-between items-start mb-3">
                        <h4 className="font-medium">{criterion.name}</h4>
                        <div className="flex gap-2">
                          <span className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm">Self: {data.self}</span>
                          <span className={`px-2 py-1 rounded text-sm ${getRatingColor(data.manager)}`}>Mgr: {data.manager}</span>
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <p className="text-xs font-semibold text-gray-600 mb-1">Employee Comments:</p>
                          {data.selfComment ? (
                            <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-gray-400">{data.selfComment}</p>
                          ) : (
                            <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                          )}
                        </div>
                        <div>
                          <p className="text-xs font-semibold text-gray-600 mb-1">Manager Comments:</p>
                          {data.managerComment ? (
                            <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-indigo-400">{data.managerComment}</p>
                          ) : (
                            <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Competencies */}
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="Award" className="w-5 h-5 text-purple-500" />Competencies</h3>
              <div className="space-y-4">
                {performanceData.criteria.competencies.map(criterion => {
                  const data = member.competencies[criterion.id];
                  if (!data) return null;
                  return (
                    <div key={criterion.id} className="p-4 bg-gray-50 rounded-lg">
                      <div className="flex justify-between items-start mb-3">
                        <h4 className="font-medium">{criterion.name}</h4>
                        <div className="flex gap-2">
                          <span className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm">Self: {data.self}</span>
                          <span className={`px-2 py-1 rounded text-sm ${getRatingColor(data.manager)}`}>Mgr: {data.manager}</span>
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <p className="text-xs font-semibold text-gray-600 mb-1">Employee Comments:</p>
                          {data.selfComment ? (
                            <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-gray-400">{data.selfComment}</p>
                          ) : (
                            <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                          )}
                        </div>
                        <div>
                          <p className="text-xs font-semibold text-gray-600 mb-1">Manager Comments:</p>
                          {data.managerComment ? (
                            <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-purple-400">{data.managerComment}</p>
                          ) : (
                            <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Goals */}
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="Target" className="w-5 h-5 text-green-500" />Goals</h3>
              <div className="space-y-4">
                {member.goals.map(goal => (
                  <div key={goal.id} className="p-4 bg-gray-50 rounded-lg">
                    <div className="flex justify-between items-start mb-3">
                      <h4 className="font-medium">{goal.name}</h4>
                      <div className="flex gap-2">
                        <span className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm">Self: {goal.self}</span>
                        <span className={`px-2 py-1 rounded text-sm ${getRatingColor(goal.manager)}`}>Mgr: {goal.manager}</span>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <p className="text-xs font-semibold text-gray-600 mb-1">Employee Comments:</p>
                        {goal.selfComment ? (
                          <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-gray-400">{goal.selfComment}</p>
                        ) : (
                          <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                        )}
                      </div>
                      <div>
                        <p className="text-xs font-semibold text-gray-600 mb-1">Manager Comments:</p>
                        {goal.managerComment ? (
                          <p className="text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-green-400">{goal.managerComment}</p>
                        ) : (
                          <p className="text-sm text-gray-400 italic bg-white p-3 rounded border-l-4 border-gray-200">No comments provided</p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Summary */}
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="FileText" className="w-5 h-5 text-gray-500" />Summary</h3>
              <p className="text-gray-700 leading-relaxed">{member.summary}</p>
            </div>
          </div>
        );
      };

      const renderCriteria = () => (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="Heart" className="w-5 h-5 text-red-500" />AAMVA CARES Values</h3>
            <div className="space-y-4">
              {performanceData.criteria.aamvaCares.map(c => (
                <div key={c.id} className="p-4 bg-red-50 rounded-lg">
                  <h4 className="font-semibold text-red-800">{c.name}</h4>
                  <p className="text-sm text-red-700 mt-1">{c.description}</p>
                </div>
              ))}
            </div>
          </div>
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><Icon name="Award" className="w-5 h-5 text-purple-500" />Competencies</h3>
            <div className="space-y-4">
              {performanceData.criteria.competencies.map(c => (
                <div key={c.id} className="p-4 bg-purple-50 rounded-lg">
                  <h4 className="font-semibold text-purple-800">{c.name}</h4>
                  <p className="text-sm text-purple-700 mt-1">{c.description}</p>
                </div>
              ))}
            </div>
          </div>
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4">Rating Scale</h3>
            <div className="space-y-2">
              {[
                { rating: 5, label: 'Outstanding', desc: 'Consistently exceeds all expectations' },
                { rating: 4, label: 'Exceeds Expectations', desc: 'Frequently exceeds expectations' },
                { rating: 3, label: 'Meets Expectations', desc: 'Consistently meets expectations' },
                { rating: 2, label: 'Needs Improvement', desc: 'Sometimes meets expectations' },
                { rating: 1, label: 'Unsatisfactory', desc: 'Does not meet expectations' },
              ].map(r => (
                <div key={r.rating} className={`p-3 rounded-lg ${getRatingColor(r.rating)}`}>
                  <span className="font-semibold">{r.rating} - {r.label}:</span> {r.desc}
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: 'LayoutDashboard' },
        { id: 'member', label: 'Team Member', icon: 'User' },
        { id: 'criteria', label: 'Criteria', icon: 'ClipboardList' },
      ];

      return (
        <div className="min-h-screen bg-gray-100">
          <div className="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-6">
            <h1 className="text-2xl font-bold">Performance Reviews</h1>
            <p className="text-indigo-100 mt-1">Track, develop, and grow your team</p>
          </div>

          {renderSyncBar()}

          <div className="border-b bg-white sticky top-0 z-10">
            <div className="flex overflow-x-auto">
              {tabs.map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                  className={`flex items-center gap-2 px-6 py-4 font-medium border-b-2 whitespace-nowrap ${
                    activeTab === tab.id ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}>
                  <Icon name={tab.icon} className="w-4 h-4" />{tab.label}
                </button>
              ))}
            </div>
          </div>

          <div className="p-6 max-w-5xl mx-auto">
            {activeTab === 'dashboard' && renderDashboard()}
            {activeTab === 'member' && renderMember()}
            {activeTab === 'criteria' && renderCriteria()}
          </div>

          <div className="bg-gray-800 text-gray-400 p-4 text-center text-sm">
            <p>"The growth and development of people is the highest calling of leadership." — Harvey S. Firestone</p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<PerformancePortal />, document.getElementById('root'));
  </script>
</body>
</html>
